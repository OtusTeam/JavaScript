.center.icon[![otus main](assets/otus-1.png)]

.hidden[
  - otus linux processes - https://youtu.be/lvdmOQKDJjk?list=PLAPBs-YOtkxUpMctJJVhwLfh7Nn4QRQKK 
  pstree
  http://man7.org/linux/man-pages/man2/setsid.2.html
  
  libuv book http://nikhilm.github.io/uvbook/
]

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Modern JavaScript Frameworks
## Node in Production, Web Assembly
### –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ—Ä–∂–∏–∫–æ–≤

---

class: top white
background-image: url(assets/sound.svg)
.top.icon[![otus main](assets/otus-2.png)]

.sound-top[
  # –ö–∞–∫ –º–µ–Ω—è —Å–ª—ã—à–Ω–æ –∏ –≤–∏–¥–Ω–æ?
]

.sound-bottom[
  ## > –ù–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç
  ### **+** –µ—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ
  ### **‚Äì** –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã c–æ –∑–≤—É–∫–æ–º –∏–ª–∏ —Å –≤–∏–¥–µ–æ
]

---

# –¢–µ–º—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è

.right-image[![GraphQL](assets/graphql.png)]

- GraphQL
- Apollo

---

# –¢–µ–º—ã

- `WebAssembly`
  - –í–≤–µ–¥–µ–Ω–∏–µ
  - –ü—Ä–∏–º–µ—Ä—ã
  - –î–∏–∑–∞–π–Ω, –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
  - –°–µ–º–∞–Ω—Ç–∏–∫–∞, `JavaScript API, Modules`
  - –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –≤ `V8`
.right-image[![Node](assets/node.png)]
- Processes
  - Process
  - child_process
  - fork, exec, spawn
  - PM2
- Node Summary

---

# –¶–µ–ª–∏

.right-image[![web assembly](assets/node.png)]

- –ü–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å `WebAssembly` - –ø–æ–Ω–∏–º–∞—Ç—å –∑–∞–¥–∞—á–∏, –æ—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
- –†–∞–∑–æ–±—Ä–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É `JavaScript` –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ `V8`, —á—Ç–æ–±—ã –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–æ–µ –º–µ—Å—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –≤ –Ω—ë–º `WebAssembly`
- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã
- –ù–∞—É—á–∏—Ç—å—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –≤ `Node`
- –ü–æ–¥–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–∏ –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π `Node`


---

# –ú–∞—Ç–µ—Ä–∏–∞–ª—ã


- [WebAssembly](https://webassembly.org/)

- [WebAssembly: Disrupting JavaScript - Dan Callahan](https://www.youtube.com/watch?v=7mBf3Gig9io)

- [WebAssembly Explorer](https://mbebenita.github.io/WasmExplorer/)

- [WebAssembly Rocks](https://www.wasmrocks.com/)

- [Node.js Official Documentation](https://nodejs.org/api/child_process.html)

- [An Introduction to libuv](http://nikhilm.github.io/uvbook/)

.right[![web assembly](assets/web-assembly-logo.png)]

.hidden[
  [Compiling for the Web with WebAssembly (Google I/O '17)](https://www.youtube.com/watch?v=6v4E6oksar0)
]

---

# Intro

### WebAssembly (abbreviated Wasm) is a **binary instruction format** for **a stack-based virtual machine**. Wasm is designed as a **portable target** for **compilation of high-level languages** like `C/C++/Rust`, enabling deployment on the web for client and server applications.

.right[![web assembly](assets/web-assembly-logo.png)]

---

# –ü—Ä–∏–º–µ—Ä

.hidden[
  https://mbebenita.github.io/WasmExplorer/
  https://webassembly.studio/
]

```c
int add(int a) {
  return a + 5;
}
```

```wasm
(module
 (table 0 anyfunc)
 (memory $0 1)
 (export "memory" (memory $0))
 (export "_Z3addi" (func $_Z3addi))
 (func $_Z3addi (; 0 ;) (param $0 i32) (result i32)
  (i32.add
   (get_local $0)
   (i32.const 5)
  )
 )
)
```

```javascript
WebAssembly.instantiateStreaming(fetch(`program.wasm`))
  .then(prog => {
      console.log(prog.instance.exports.add(1, 2))
  })
```

.hidden[
  https://developers.google.com/web/updates/2012/06/How-to-convert-ArrayBuffer-to-and-from-String
  
  /Users/RD25XO/Developer/experiments/notes/otus/webassembly/program.wasm
  
  https://openhome.cc/eGossip/WebAssembly/Wat2Wasm.html
]

---

# –ò—Å—Ç–æ—Ä–∏—è

.hidden[
  https://en.wikipedia.org/wiki/WebAssembly#History
  
  http://asmjs.org/spec/latest/
  
  https://en.wikipedia.org/wiki/Google_Native_Client
]

- [Google Native Client](https://developer.chrome.com/native-client) (`NaCl` and `PNaCl`) üòÖ
  - `9 December 2011`
- [`asm.js`](http://asmjs.org/) - –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ `JavaScript`
  - `11 October 2013` - `18 August 2014`
  .hidden[
  > ASM.js is a subset of JavaScript that has no objects and has no garbage collection or just in time compiler pauses. It‚Äôs a target for C/C++‚Ää‚Äî‚Ääa statically typed subset of JavaScript. This was demonstrated at Mozilla in partnership with the big gaming companies like Epic Games with Unreal Engine and Unity with the Unity engine and IDE. [(c) Brendan Eich](https://medium.com/javascript-scene/why-we-need-webassembly-an-interview-with-brendan-eich-7fb2a60b0723)
  ]


- –ê–Ω–æ–Ω—Å –≤ `2015` .right-code[![web assembly](assets/web-assembly-logo.png)]
  - `WebAssembly Working Group`
  - `Core Specification`, 2016
  - –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –ª–æ–≥–æ, 2017 üòÇ 
  - *Browser Preview*


.hidden[
  WebAssembly Working Group in April, 2015, to standardize WebAssembly and oversee the specification and proposal process. Since then, the Core Specification in April, 2015, to standardize WebAssembly and oversee the specification and proposal process. Since then, the Core Specification
]

---

# [–ü—Ä–∏–º–µ—Ä—ã](https://webassembly.org/docs/use-cases/)

- **Web**
  - –ú–µ–¥–∏–∞
  - –ò–≥—Ä—ã
  - –ü—Ä–æ—Ç–æ–∫–æ–ª—ã –Ω–∏–∑–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
  - Machine Learning
  - ...
  - > Any Possible Client Executed Code

- **Server Side ?!**
  - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
  - ... 
  - > Any Stable Predictable Rich Environment

---

# –ü–æ–¥–¥–µ—Ä–∂–∫–∞

.right.height-400[
  ![wasm](assets/languages-supported-by-wasm.png)
]

### [–Ø–∑—ã–∫–∏](https://github.com/appcypher/awesome-wasm-langs)

### –ë—Ä–∞—É–∑–µ—Ä—ã

.half-image[
  ![](assets/wasm-browser-support.png)
]

<br>
> Global - 85.57%

### [Server-Side](https://webassembly.org/docs/portability/)

---

# [Design Goals - Semantics](https://webassembly.github.io/spec/core/intro/introduction.html#design-goals)

- **Fast**: executes with near native code performance, taking advantage of capabilities common to all contemporary hardware
- **Safe**: code is validated and executes in a memory-safe [2], sandboxed environment preventing data corruption or security breaches
- **Well-defined**
- **Hardware-independent**
- **Language-independent**
- **Platform-independent**
- **Open**: programs can interoperate with their environment in a simple and universal manner

---

# [Design Goals - Representation](https://webassembly.github.io/spec/core/intro/introduction.html#design-goals)

- **Compact**: has a binary format that is fast to transmit by being smaller than typical text or native code formats
- **Modular**: programs can be split up in smaller parts that can be transmitted, cached, and consumed separately
- **Efficient**: can be decoded, validated, and compiled in a fast single pass, equally with either just-in-time (JIT) or ahead-of-time (AOT) compilation.
- **Streamable**
- **Parallelizable**
- **Portable**

---

# [–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ MVP](https://webassembly.org/docs/mvp/)

- `Module` —Å `JavaScript API` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- `Binary format (wasm)` - –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä –∏ –±—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥
- `Text format`, [wat](https://www.destroyallsoftware.com/talks/wat) - —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
- `wasm` –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä
- [WebAssembly High-Level Goals](https://webassembly.org/docs/high-level-goals/)
  - *execute in the same semantic universe as JavaScript* ü§î
  
- **–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (–ø–æ–∫–∞)**
  - Garbage collector (Proposal) 
  - DOM access
  - –°—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã
  - Threads
  
.hidden[
  # Elements Of WebAssembly 
  - Text Format (wat)
]

---

# Definitions

- –ß—Ç–æ —Ç–∞–∫–æ–µ `Virtual Machine`?
- –ß—Ç–æ —Ç–∞–∫–æ–µ `Stack-based Virtual Machine`?

.right-image[
  ![web assembly actors](assets/web-assembly-actors.png)
]
.half-image[
![Stack-based Virtual Machine](assets/Stack_3.png)
]

.hidden[
  Stack-based virtual machine 
  https://andreabergia.com/stack-based-virtual-machines/
  
  > What‚Äôs a stack based virtual machine then? It‚Äôs an abstraction of a computer, that emulates a real machine. Generally it is built as an interpreter of a special bytecode, that translates its in real time for execution on the CPU.
  
  JVM is stack-based
  
  Also possible a register based vm
  
  > structured stack machine; a machine where most computations use a stack of values, but control flow is expressed in structured constructs such as blocks, ifs, and loops

  - Stack 
  - Instructions
  - Linear Memory
  
  https://jaytaylor.com/notes/assets/6b15f756-cec3-4402-997b-d04b76acd87e-0.pdf
]

---

# WebAssembly

.right-code[
- Data Operations
  - i32: + - * / % << >> >>> etc
  - i64: + - * / % << >> >>> etc
  - f32: + - * / sqrt ceil floor
  - f64: + - * / sqrt ceil floor
  - conversions
  - load store
  - call_direct call_indirect
- Structured Control Flow
  - if loop block br switch
]

- Data Types
  - void i32 i64 f32 f64
- Functions
  - Flat, single global table
  - Static binding
  - Indirect calls through table
- State: linear memory
  - large, bounds-checked array
- Trusted execution stack

---

# JavaScript API

.hidden[
  > A JavaScript API is provided which allows JavaScript to compile WebAssembly modules, perform limited reflection on compiled modules, store and retrieve compiled modules from offline storage, instantiate compiled modules with JavaScript imports, call the exported functions of instantiated modules, alias the exported memory of instantiated modules, etc.
  
  https://webassembly.org/docs/web/
  
  http://webassembly.github.io/spec/js-api/index.html
  
  /Users/RD25XO/Developer/experiments/notes/otus/webassembly/test2.wasm
]

- `WebAssembly` object
  - `Module`, `Instance`, `Memory`, `Table`
  - `validate()` 
  - `compile()`
  - `instantiate()`

```
var importObj = {js: {
  import1: () => console.log("hello,"),
  import2: () => console.log("world!"),
}};
fetch('demo.wasm').then(response =>
  response.arrayBuffer()
).then(buffer =>
  WebAssembly.instantiate(buffer, importObj)
).then(({module, instance}) =>
  instance.exports.f()
);
```

---

# [Modules](https://webassembly.org/docs/modules/)

> The distributable, loadable, and executable unit of code in WebAssembly

- `imports`: `js, env, table, memory`

```wamp
(module
    (import "js" "import1" (func $i1))
    (import "js" "import2" (func $i2))
    (func $main (call $i1))
    (start $main)
    (func (export "f") (call $i2))
)
```

- <a href="https://github.com/WebAssembly/design/issues/1087">üõ§ ECMAScript module integration#12</a>

```
<script type="module" src="proposal.wasm"></script>
```

---

# Demo

- [PNaCl Getting Started](https://developer.chrome.com/native-client/devguide/tutorial/tutorial-part1) 

- [Simple Add Function](otus/webassembly/add.wat) 
- [Call Imported API](otus/webassembly/import.wat) 
- [Store API](otus/webassembly/store.wat) 
- [Add with C and WASM Explorer](otus/webassembly/c-add.wasm, https://mbebenita.github.io/WasmExplorer/) 

---

# Compile Flow

- `Emscripten` - –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –≤ `WebAssembly`

```
C/C++/Rust -> AST -> Binary (.wasm) -> AST -> ...Module
```

.right-image[
  ![web assembly compile flow diagram](assets/webassembly-v8-js-vs-wasm.png)
]

.half-image[
  ![web assembly compile flow diagram](assets/web-assembly-compile-flow-diagram.png)
]


.hidden[
```mermaid
graph TD
 pending-->fulfilled
 pending-->rejected
```
> WebAssembly code in text format is serialized into an AST and compiled to the binary format (as a .wasm file), which is fetched, loaded, and utilized by a web page. When the module is loaded, the browser's JavaScript engine utilizes a decoding stack to decode the .wasm file into an AST, perform type checking, and interpret it to execute functions.
]

---

# Real World Examples

- `ZIP` for `WebAssembly` ?!
  - [Almost](https://github.com/YuJianrong/node-unrar.js)
  
- [Doom 3](http://www.continuation-labs.com/projects/d3wasm/)
- [Windows 95](https://win95.ajf.me/win95.html)

### –î—Ä—É–≥–∏–µ –ø—Ä–∏–º–µ—Ä—ã

- `SASS` for `WebAssembly`
- Dynamic [`Polyfills` not only for `Web`](https://developer.mozilla.org/en-US/docs/WebAssembly/existing_C_to_wasm)
- [Video / Image Filters](http://tiny.cc/webdsp)
- [Games](https://hackernoon.com/games-build-on-webassembly-3679b3962a19)

.hidden[
---
# Demo

```c
#define EXIT_STATUS EXIT_FAILURE
#include "true.c"
```
]

---

# –†–µ–∑—é–º–µ

- `WebAssembly` —Å–≤—è–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å `JavaScript` –∏ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —Å —á–∏—Å–ª–∞–º–∏

- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–µ–∂—è–∑—ã–∫–æ–≤–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª

### Question

- –ï—Å—Ç—å –ª–∏ –¥—Ä—É–≥–∏–µ –∫–ª–∏–µ–Ω—Ç—ã –∫—Ä–æ–º–µ `JavaScript`?

.hidden[
  > Non-Web environments may include JavaScript VMs (e.g. node.js), however WebAssembly is also being designed to be capable of being executed without a JavaScript VM present.
]

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Web Assembly Q&A

---

# Single Thread

### –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ `Node` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è `Event Loop`, –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –≤–º–µ—Å—Ç–µ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ (`API, setTimeout, process.nextTick`), –ø–æ—Å–ª–µ —á–µ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–±–æ—Ç–∞ `Event Loop`


.center.half-image[
  ![event loop](assets/node/eventloop.png)
]

.hidden[
> Thread-safety is one less concern for developers to waste time worrying about

> Performance measures the speed with which a single request can be executed, while scalability measures the ability of a request to maintain its performance under increasing load.
]

---

# Terminology

.hidden[
  otus linux processes https://youtu.be/lvdmOQKDJjk?list=PLAPBs-YOtkxUpMctJJVhwLfh7Nn4QRQKK
]

.hidden[
  TODO
  
  ![](assets/linux_kernel.jpg)
  shell?
  
  > The GNU/Linux shell is a special interactive utility. It provides a way for users to start programs, manage files on the filesystem, and manage processes running on the Linux system. The core of the shell is the command prompt. The command prompt is the interactive part of the shell. It allows you to enter text commands, and then it interprets the commands and executes them in the kernel.
  https://learning.oreilly.com/library/view/Linux+Command+Line+and+Shell+Scripting+Bible,+3rd+Edition/9781118983843/11_chapter01.html#chap1
]

- **Process** - –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç
- **System Call** - –∑–∞–ø—Ä–æ—Å—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å —è–¥—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
  - Process Creation & Management
.right-code[![process](assets/process.png)]
  - File Access
  - Networking
  - Memory Management
- **Thread** - —á–∞—Å—Ç–∏—á–Ω–∞—è –∫–æ–ø–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –µ–≥–æ —Ä–µ—Å—É—Ä—Å–∞–º

---

# Process

.right-code[
### Tools

- kill - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å—É

–î–µ—Ä–µ–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
- htop
- ps
- pstree

.hidden[
  https://www.geeksforgeeks.org/operating-system-introduction-system-call/

  Services Provided by System Calls :
  - Process creation and management
  - Main memory management
  - File Access, Directory and File system management
  - Device handling(I/O)
  - Protection
  - Networking, etc.

  Types of System Calls : There are 5 different categories of system calls ‚Äì
  - Process control: end, abort, create, terminate, allocate and free memory.
  - File management: create, open, close, delete, read file etc.
  - Device management
  - Information maintenance
  - Communication
]
]

### Properties

- `pid` - –ø—Ä–æ—Ü–µ—Å—Å–∞ 
- `ppid` - —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- `gid, uid`
- environment variables
- `cwd`
- terminal, priority
- `state`

---

# Fork

.hidden[
  http://man7.org/linux/man-pages/man2/fork.2.html
  http://man7.org/linux/man-pages/man2/clone.2.html
]

- popen() - —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- fork() - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- exec() - –∑–∞–º–µ—â–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- clone() - —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ (thread)

```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main() {
  int status
  printf("before \n")
  int id = fork()
  printf("parent id %d\n", getppid())
  printf("my id %d\n", getpid())
  printf("child id %d\n", id)
  printf("--- \n")                   // —á—Ç–æ –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω–æ –Ω–∞ —ç–∫—Ä–∞–Ω?
  return 0
}
```

<!-- - –ß—Ç–æ –±—É–¥–µ—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ? -->

---

# Child Process

–ú–æ–¥—É–ª—å `child_process` —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç

.right-image[![Node](assets/node.png)]
- `spawn()`, 
- `fork()`, 
- `exec()`, 
- `execFile()` –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ 

–ú–µ—Ç–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `ChildProcess` –æ–±—ä–µ–∫—Ç, —è–≤–ª—è—é—â–∏–π—Å—è `EventEmitter`

---

# Spawn

.right-code[
```
const { spawn } 
  = require('child_process')
  
spawn('ps', ['ax'])
```
]

- `command`
- `[arguments]` - command-line arguments
- `[options]` - `spawn()` settings

Options:
- `cwd` - (current) working directory
- `env` - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- `detached` - –æ—Ç—Ü–µ–ø–∏—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- `stdio` - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –≤–≤–æ–¥–∞ –≤—ã–≤–æ–¥–∞ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

---

# –í–æ–ø—Ä–æ—Å

```
const spawn = require('child_process').spawn
let ls = spawn('ls', ['-lh', '.'])
ls.stdout.on('readable', function() {
    let d = this.read()
    d && console.log(d.toString())
})
ls.on('close', code => {
    console.log(`child process exited with code: ${code}`)
})
```

### –ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

.center[![question](assets/question.png)]

.hidden[
  Here, we spawn the ls process (list directory), and read from the resulting readable Stream, receiving something like this:

  -rw-r--r-- 1 root root 43 Jul 9 19:44 index.html
  -rw-rw-r-- 1 root root 278 Jul 15 16:36 child_example.js
  -rw-r--r-- 1 root root 1.2K Jul 14 19:08 server.js
  child process exited with code 0
]

---

# ChildProcess

- `stdio` - –ø–æ—Ç–æ–∫–∏ `stdin, stdout, stderr` - `'pipe', 'inherit', 'ignore'`, `'ipc'`
- `unref(), ref()` - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º Event Loop
- `send(), on()` - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- `kill()` - `'SIGTERM'`

### Events

- `'exit'` - –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è
- `'close'` - –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Ç–æ–∫–∏
- `'message'` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç `process.send()`

---

# Demo Signal

```
setInterval(() => {
  console.log('hello')
}, 500);

process.addListener('SIGINT', () => {
  console.log('got it')
  process.exit(0)
})
```

---

# Fork & Exec


- `spawn[Sync]()` - `pipe + fork + shell`
- `fork()`
.right-image[![Node](assets/node.png)]
  - `IPC` communication channel

- `exec[Sync]()` - –ø–æ–ª–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
  - `[callback]`
  - `timeout` - –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
- `execFile[Sync]()` - –±–µ–∑ `shell`
  - `[callback]`

.hidden[
  > Like spawn, fork starts a child process, but is designed for running Node programs with the added benefit of having a communication channel built in
  
  > Unlike the fork(2) POSIX system call, child_process.fork() does not clone the current process.

### exec
> the complete buffered output of a child process
> command with arguments `ps aux | grep node` instead of executable

- timeout
]

---

# Demo Fork

```js
console.log('before')

const { fork } = require('child_process')

const pid = process.pid

if (process.argv[process.argv.length - 1] === 'true') return

const childId = fork('./fork', [true])

console.log('parent id %d', process.ppid)
console.log('my id', pid)
console.log('child id', childId.pid)

console.log('after')
```

---

# –í–æ–ø—Ä–æ—Å

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å `promisify()`?

```
const util = require('util')
const exec = util.promisify(require('child_process').exec)

async function lsExample() {
  const { stdout, stderr } = await exec('ls')
  console.log('stdout:', stdout)
  console.log('stderr:', stderr)
}
lsExample()
```

---

# Cluster

### –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∞—Ä–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã 

```
const cluster = require('cluster')
const http = require('http')
const numCPUs = require('os').cpus().length

if(cluster.isMaster) {
   for(let i = 0; i < numCPUs; i++) {
      cluster.fork()
   }
}

if(cluster.isWorker) {
   http.createServer((req, res) => {
      res.writeHead(200)
      res.end(`Hello from ${cluster.worker.id}`)
   }).listen(8080)
}
```

---

# Worker Threads

```
const { Worker, isMainThread } = require('worker_threads')

if (isMainThread) {
  new Worker(__filename)
  console.log(process.pid)
} else {
  console.log(isMainThread)
  setTimeout(() => {
    console.log('Inside Worker!')
    console.log(process.pid)
  }, 1e4)
}
```

- `workerData` - –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –≤ `constructor`
- `ArrayBuffer, SharedArrayBuffer` –¥–ª—è –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

---

# PM2

> Advanced, production process manager for Node.js

```
pm2 start http.js -i max
```

```
var http = require('http')

var server = http.createServer(function(req, res) {
  res.writeHead(200)
  res.end('hey')
}).listen(process.env.PORT || 8000, function() {
  console.log('App listening on port %d', server.address().port)
})
```

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Q&A

---

# Node Summary

- –ö–∞–∫–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —É `Node`?

.center[![question](assets/question.png)]

<br>
<br>
- [Design Mistakes in Node](assets/jsconf2018.pdf)
- Deno

---

# Modern JavaScript Frameworks

.mario.mario-11[![mario](assets/mario.png)]
<!-- .mario.mushroom[![mushroom](assets/mario_mushroom.png)] -->

| ![JS](assets/icons/trim/js.png) | ![Node](assets/icons/trim/node.png) | ![Web Components](assets/icons/trim/webcomponents.png) | ![React](assets/icons/trim/react.png) | ![Vue](assets/icons/trim/vue.png) | ![Angular](assets/icons/trim/angular.png) |
|:---:|:---:|:---:|:---:|:---:|:---:|
| ![Google Chrome](assets/icons/trim/google_chrome.png) | ![NPM](assets/icons/trim/npm.png) | ![polymer](assets/icons/trim/polymer.png) | ![redux](assets/icons/trim/redux.png) | | ![ts](assets/icons/trim/ts.png) |
| ![wasm](assets/web-assembly-logo.png) | ![v8](assets/icons/trim/v8.png) | | ![react-router](assets/icons/trim/react-router.png) | | ![rxjs](assets/icons/trim/rxjs.png) |
| | ![Express](assets/icons/trim/express.png) | |
| | ![GraphQL](assets/icons/trim/graphql.png) | |

---

# –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞

![no homework](assets/no-homework.png)

---

# Notes

- [x] –≠—Ç–∏ –¥–µ–º–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –∑–∞–Ω—è—Ç–∏—è?‚Ä©
- [x] https://playclassic.games/

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ!
.black[ 
## –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ –æ–ø—Ä–æ—Å 
## –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ 
]

- –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –í—ã —Ç—Ä–∞—Ç–∏—Ç–µ –Ω–∞ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É?