.hidden[
  - http://blogoscoped.com/google-chrome/  
  - https://blog.npmjs.org/post/178027064160/next-generation-package-management
  - https://github.com/npm/tink
]

.center.icon[![otus main](assets/otus-1.png)]

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Modern JavaScript Frameworks
## Введение в Node
### Александр Коржиков

---

class: top white
background-image: url(assets/sound.svg)
.top.icon[![otus main](assets/otus-2.png)]

.sound-top[
  # Как меня слышно и видно?
]

.sound-bottom[
  ## > Напишите в чат
  ### **+** если все хорошо
  ### **–** если есть проблемы cо звуком или с видео
]

---

# Changelog

- NodeConf EU 2018 - Kilkenny, Ireland

### https://www.nodeconf.eu/

- Node ES Modules - Something almost, but not quite entirely unlike `CommonJS` by Gil Tayar

---

# Темы предыдущего занятия
.right-image[![JS](assets/js.png)]

- Inheritance
- Promise
- Ajax

---

# Modern JavaScript Frameworks

.mario.mario-2[![mario](assets/mario.png)]

| ![JS](assets/icons/trim/js.png) | ![Node](assets/icons/trim/node.png) | ![Web Components](assets/icons/trim/webcomponents.png) | ![React](assets/icons/trim/react.png) | ![Vue](assets/icons/trim/vue.png) | ![Angular](assets/icons/trim/angular.png) |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| ![Google Chrome](assets/icons/trim/google_chrome.png) | ![NPM](assets/icons/trim/npm.png) | ![polymer](assets/icons/trim/polymer.png) | ![redux](assets/icons/trim/redux.png) | | ![ts](assets/icons/trim/ts.png) |
| | ![v8](assets/icons/trim/v8.png) | | ![react-router](assets/icons/trim/react-router.png) | | ![rxjs](assets/icons/trim/rxjs.png) |
| | ![Express](assets/icons/trim/express.png) | |
| | ![GraphQL](assets/icons/trim/graphql.png) | |

---

# Цели занятия

- Запускать приложения на платформе `Node`
- Работать с пакетным менеджером `NPM`
- Управлять зависимостями и автоматизировать задачи с помощью `package.json`

---

# Содержание

- Node
  - About
  - Пример Web сервера
  - Структура
  - Стандартные модули
  - Примеры Callbacks
- NPM
  - package.json
  - cli

---

# Docs

- https://nodejs.org/en/docs/guides/ 

### Node core concepts

- https://docs.npmjs.com/ 

### package manager for javascript

---

# Node

### Асинхронная среда исполнения `JavaScript`, основанная на событийной модели, для создания эффективных сетевых приложений

- Пример web сервера

```javascript
const http = require('http') 
const hostname = '127.0.0.1'
const port = 3000
const server = http.createServer((req, res) => {
  res.statusCode = 200 
  res.setHeader('Content-Type', 'text/plain') 
  res.end('Hello World\n')
}) 

server.listen(port, hostname, () => {
  console.log(`Server running at http://${hostname}:${port}/`)
})
```

- Демо

---

# История

.right-image[
  ![v8](assets/icons/trim/v8.png)
]

- *Server side `JavaScript` Platform* - Ryand Dahl, 2009
- Asyncronous (non-blocking) I/O
- Chromium `JavaScript` Engine -> V8
- **Node.js** Foundation

---

# Особенности

- Исполнение `JavaScript` файлов с помощью комманды node 
  
  - REPL

- `CommonJS` формат модулей для загрузки зависимостей
  
  - `ES Modules`

- Стандартная библиотека модулей

- API основанное на асинхронном паттерне Callbacks

- `ES2015` синтаксис

---

# Структура

.right-image[
  ![node](assets/icons/trim/node.png)
]

- Библиотека написана на `C++` и `JavaScript` 

- `V8` - платформа исполнения `JavaScript` от Google (Chromium, Chrome, Opera, Brave, Yandex Browser)

- Event Loop - асинхронный событийный цикл с `libuv`

- Модули для работы с операционной системой

---

# Задача

Установить node и npm
https://nodejs.org/en/download/

```bash
node --version
npm --version
```

Создать и запустить `server.js`

```
console.log(process.argv)
```

```bash
node server hello world
```

---

# Вопрос

### А Вы знаете какие модули включены в стандартный дистрибутив `Node`?

<br>

.center[
  ![question](assets/question.png)
]

---

# Стандартные модули

.right-code[
- Protocols
  - http(s)
  - net
  - dns
- System
  - os
  - v8
  - async_hooks 
  - perf_hooks
  - trace_events
]

- Main
  - fs
  - timers
  - streams
- Utilities
  - path
  - util
  - zlib
  - crypto
- Processes
  - child_process
  - cluster
  - worker_threads

---

# Utilities

.left-code[
```
const querystring = require('querystring')

querystring.parse(`q=shell+ls+regex&
rlz=1C5CHFA_enNL772ED772&
oq=shell+ls+by+reg&
aqs=chrome.1.63i27j0a4.4221e0b9&
sourceid=chrome&ie=UTF-8
`)

{
  "q": "shell ls regex",
  "rlz": "1C5CHFA_enNL772ED772",
  "oq": "shell ls by reg",
  "aqs": "chrome.1.63i27j0a4.4221e0b9",
  "sourceid": "chrome",
  "ie": "UTF-8"
}
```
]

- querystring

---

# Utilities

.left-code[
```
const path = require('path')

path.join('/Users', 'alex', 'Sites')
// =>
'/Users/alex/Sites'

path.parse('/home/user/dir/file.txt')

{
  root: '/',
  dir: '/home/user/dir',
  base: 'file.txt',
  ext: '.txt',
  name: 'file'
}
```
]

- querystring
- path

---

# Utilities

.left-code[
```javascript
const url = require('url')
url.parse('https://github.com/korzio')

// Url 
{
  protocol: 'https:',
  slashes: true,
  auth: null,
  host: 'github.com',
  port: null,
  hostname: 'github.com',
  hash: null,
  search: null,
  query: null,
  pathname: '/korzio',
  path: '/korzio',
  href: 'https://github.com/korzio' 
}
```
]

- querystring
- path
- url

---

# Utilities

.left-code[
```javascript
const util = require('util')
const assert = require('assert')

util.types.isDate(value)
// or deprecated
util.isDate(value)
// or inherit
util.inherits(MyStream, EventEmitter)

assert.equal(1, 1)
assert.deepEqual({ a: 1 }, { a: 1 })
```
]

- querystring
- path
- url
- util
- assert

---

# Callbacks

.left-code[
```
// default
fs.readFile('/etc/passwd', (err, data) => {
  if (err) throw err
  console.log(data)
})

// single
fs.access('/etc/passwd', fs.constants.R_OK, 
(err) => {
  console.log(err ? 'no access!' : 'read')
})

// ... http server ...
const server = http.createServer((req, res) => {
  res.statusCode = 200
  res.setHeader('Content-Type', 'text/plain')
  res.end('Hello World\n')
})

server.listen(port, hostname, () => {
  console.log(`Server running at 
     http://${hostname}:${port}/`)
})
```
]

- `default` - вызывается с ошибкой или результатом
- `single` - только с ошибкой

TODO - request('https://example.com', (error, response, body) => {
  ...
});

- А также поддержка `Promise`

```
util.promisify()
fs.promises.*
```

---

# Global

.right-image[
  ![node](assets/icons/trim/node.png)
]

- `global` объект - аналог `window`
- объекты `JavaScript`
- *timeouts* почти как в браузере
- `console` 
- `process` репрезентация текущего процесса

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Node Q&A

---

# NPM

### Package Manager for JavaScript

![NPM](assets/icons/trim/npm.png)

- CI

```bash
npm --version
```

- Registry

```bash
npm i
```

- Website https://npmjs.com/ 

---

# В числах


.right-image[
  ![npm downloads](assets/npm_downloads.png)  
]

### Всего зарегистрировано 828 521 пакетов

### Скачиваний

- за неделю - 6 047 009 596
- за месяц - 27 898 612 172
- `react` - 2 715 081

<br>
### **Node** 2017

25 000 000

.right-code[
  ![NPM](assets/icons/trim/npm.png)
]

<br>
### *Звезд во Вселенной*

1 000 000 000 000 000 000 000 

---

# package.json

.left-code[
```
{
  "name": "package",
  "description": "",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\"
&& exit 1"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/.../package.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/.../issues"
  },
  "homepage": "https://github.com/.../package"
}
```
]

- `name`
- `version` - `semver`
- `main` - файл по умолчанию
- `scripts` - служебные команды

---

# Semantic Versioning

- Спецификация 
https://semver.org/ 

- Калькулятор
https://semver.npmjs.com/ 

```bash
npm install semver
```

| Status | Stage | Version |
|---|---|---|
| First release | New product | 1.0.0 |
| Bug fix | patch | 1.0.1 |
| New Feature | minor | 1.1.1 |
| Breaking change | major | 2.0.0 |

***

<br>

- Какие альтернативные нотации версионирования Вы знаете?

---

# CLI

.left-code[
```
{
  "name": "mypkg",
  "description": "",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" 
&& exit 1"
  },
  "repository": {
    "type": "git",
    "url": "https://github.com/.../mypkg.git"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "bugs": {
    "url": "https://github.com/.../mypkg/issues"
  },
  "homepage": "https://github.com/.../mypkg"
}
```
]

- Основные
  - init
  - install
  - start 
  - test
  - run
- Дополнительные
  - ci 
  - npx 

---

# Самостоятельная работа

Создать новый `npm` пакет

```bash
mkdir ... && cd ... 
npm init # read & answer
```

Сохранить зависимость

```bash
npm install --save-dev ... 
# copy & paste package.json > chat
```

Запустить скрипты

```bash
echo "" > server.js # create file
npm start
npm test # npm run test
```

---

# Зависимости

.left-code[
```
  "dependencies": {
    "commander": "^2.7.1",
    "lodash.get": "^4.0.0",
    "lodash.isequal": "^4.0.0",
    "validator": "^9.0.0"
  },
  "devDependencies": {
    "coveralls": "^3.0.0",
    "grunt": "^1.0.1",
    "grunt-browserify": "^5.2.0",
    "grunt-cli": "^1.2.0",
    "grunt-contrib-copy": "^1.0.0",
    "grunt-jscs": "^3.0.1",
    "grunt-lineending": "^1.0.0",
    "jasmine-node": "^1.14.5",
    "jasmine-reporters": "^2.2.1",
    "remapify": "^2.1.0"
  }
```
]

- dependencies
  - devDependencies разработчика
  - peerDependencies плагины
  - bundleDependencies дистрибутив (сокращает время установки зависимостей)

.hidden[
  Another great way to speed up installation time is to include all production dependencies in the published module. We can tell npm to bundle them with our module by adding them as bundleDependencies to our package.json:
  "bundleDependencies": [
    "config-chain",
    "nopt",
    "npmlog",
    "opener",
    "osenv",
    "request"
  ],
  Bundling the dependencies reduces the installation time a lot, as we omit all the small HTTP requests for each dependency and their dependencies during installation. With the current npm, installation time is reduced from 20 seconds to 5 seconds for a broadband connection. Bundling the dependencies also makes sure that our package is still installable even if a module was unpublished.
  When we now run npm publish, we will publish a highly optimized version of our package.
  
  https://learning.oreilly.com/library/view/the-cli-book/9781484231777/A456043_1_En_3_Chapter.html
]
  
  - optionalDependencies необязательные
- flag `--global`
- `node_modules` -->

---

# node_modules

.right-code[
```
# A{B,C}, B{C}, C{D}
A
+-- B
+-- C
+-- D

# A{B,C}, B{C,D@1}, C{D@2}
A
+-- B
+-- C 
    +-- D@2
+-- D@1
```
]

- Locks
  - package-lock.json
  - npm-shrinkwrap.json
- Альтернативы
  - yarn
  - bower
  - turbo
- Proposals
  - tink

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# NPM Q&A

---

# На занятии

- Запускать приложения на платформе Node
- Использовать NPM для создания, добавления зависимостей и использования скриптов

---

# Modern JavaScript Frameworks

.mario.mario-3[![mario](assets/mario.png)]
<!-- .mario.mushroom[![mushroom](assets/mario_mushroom.png)] -->

| ![JS](assets/icons/trim/js.png) | ![Node](assets/icons/trim/node.png) | ![Web Components](assets/icons/trim/webcomponents.png) | ![React](assets/icons/trim/react.png) | ![Vue](assets/icons/trim/vue.png) | ![Angular](assets/icons/trim/angular.png) |
|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|:-------------:|
| ![Google Chrome](assets/icons/trim/google_chrome.png) | ![NPM](assets/icons/trim/npm.png) | ![polymer](assets/icons/trim/polymer.png) | ![redux](assets/icons/trim/redux.png) | | ![ts](assets/icons/trim/ts.png) |
| | ![v8](assets/icons/trim/v8.png) | | ![react-router](assets/icons/trim/react-router.png) | | ![rxjs](assets/icons/trim/rxjs.png) |
| | ![Express](assets/icons/trim/express.png) | |
| | ![GraphQL](assets/icons/trim/graphql.png) | |

---

# Самостоятельная работа

- Создать локальный веб сервер `server`, отвечающий на запросы каждые 100ms

- Создать скрипт `request`, принимающий на вход 
  - количество запросов `N`
  - тип запросов - параллельный или последовательный

<br>

### Скрипт `request` должен отправлять `N` последовательных или параллельных `HTTP` запросов к локальному серверу `server`

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Спасибо за внимание!
.black[ 
## Пожалуйста, пройдите опрос 
## в личном кабинете 
]

- Все ли темы были понятны? (да - нет)
- Легкий материал или нет? (1 просто - 10 сложно)

.hidden[
Automated software verification and validation process
facilitate refactoring
improves code structure
adds documentation and examples
Testing

Types of tests
Unit tests are close to the source, focus on small pieces of API in isolation
Integration tests validate an interaction of modules and services
End-to-end (System) tests check system with user behavior replica

it('should return undefined if object is valid', () => {
 // setup // arrange
 const env = djv()
 env.addSchema('test', jsonSchema)
 const commonObj = { type: 'common' }
 const expected = undefined

 // exercise // act
 const result = env.validate('test#/common', commonObj)
 // verification // assert
 assert.equal(result, expected)
 // teardown
})
Test structure


describe('arrayContaining', () => {
 const expected = ['Alice', 'Bob']

 it('matches even if received contains additional elements', () => {

 expect(['Alice', 'Bob', 'Eve']) .toEqual( expect.arrayContaining(expected) )
 })
})

describe()
test()
beforeEach() 
afterEach()
expect
done()
Keywords


const video = require('./video')

test('plays video', () => {
 const spy = jest.spyOn(video, 'play')
 const isPlaying = video.play()

 expect(spy).toHaveBeenCalled()
 expect(isPlaying).toBe(true)

 spy.mockRestore()
})
Concepts
stubs - predefined responses
spies - save calls
mocks - behavior verification


jest - React
jasmine, karma - Angular
mocha, chai, sinon - Polymer
wct - Polymer
protractor - Angular
webdriver i/o - ...
cucumber
Tools

Fast
Independent / Isolated
Repeatable
Self-Validating
Timely

Unit testing best practices

Fast - tests should run fast
Independent / Isolated - the order shouldn't matter
Repeatable - deterministic or idempotent
Self-Validating - should output the result
Timely - should be close to the source code

Unit testing best practices

Test-Driven Development (TDD) is a technique for building software that guides software development by writing tests

Don't write code except to pass a failing test
Write only enough of a test to show the failure
Write only enough code to pass the failing test

TDD

TDD Algorithm
Write a failing test
Make the test pass
Refactor
Feature: In order to keep my product stable As a developer or product manager I want to make sure that everything works as expectedScenario: Check title of website after search Given I open the url "http://google.com" When I set "WebdriverIO" to the inputfield "#lst-ib" And I press "Enter" Then I expect that the title is "WebdriverIO - Google Search"Scenario: Another test Given ...

BDD
to get developers, testers and business to talk to each other (Gherkin language)
Feature
Scenario
Given
When
Then
Q&A
]