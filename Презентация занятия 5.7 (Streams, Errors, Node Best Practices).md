.hidden[
  https://r.va.gg/2014/06/why-i-dont-use-nodes-core-stream-module.html
  https://nodejs.org/en/docs/guides/backpressuring-in-streams/
]

.center.icon[![otus main](assets/otus-1.png)]

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Modern JavaScript Frameworks
## Streams, Errors
### –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö–æ—Ä–∂–∏–∫–æ–≤

---

class: top white
background-image: url(assets/sound.svg)
.top.icon[![otus main](assets/otus-2.png)]

.sound-top[
  # –ö–∞–∫ –º–µ–Ω—è —Å–ª—ã—à–Ω–æ –∏ –≤–∏–¥–Ω–æ?
]

.sound-bottom[
  ## > –ù–∞–ø–∏—à–∏—Ç–µ –≤ —á–∞—Ç
  ### **+** –µ—Å–ª–∏ –≤—Å–µ —Ö–æ—Ä–æ—à–æ
  ### **‚Äì** –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã c–æ –∑–≤—É–∫–æ–º –∏–ª–∏ —Å –≤–∏–¥–µ–æ
]

---

# –¢–µ–º—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–Ω—è—Ç–∏—è

.right-image[![Node](assets/node.png)]

- Events
  - EventEmitter
- Event Loop
- Timers
  - `setTimeout()`
  - `setInterval()`
  - `process.nextTick()`
  - `setImmediate()`

---

# Changelog

- 5 –ê–≤–≥—É—Å—Ç–∞ 
  
> `WebAssembly` -> `Node in Production && WebAssembly`

---

# –¢–µ–º—ã –∏ –¶–µ–ª–∏

.right-image[![](assets/node.png)]

- Streams
  - –ü—Ä–∏–º–µ—Ä—ã –∏ —Ç–∏–ø—ã –ø–æ—Ç–æ–∫–æ–≤
  - API
  - Pipe
  - Iterable Streams
- Errors 
  - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏
  - –°–ø–æ—Å–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

- > –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å—ã, –æ–±—ä–µ–∫—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–¥—É–ª—è `Streams`
- > –†–∞–±–æ—Ç–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ `JavaScript` –∫–æ–¥–∞

---

# Docs


.right-image[![](assets/node.png)]

- [Streams API](https://nodejs.org/api/stream.html)

- [Backpressuring in Streams](https://nodejs.org/en/docs/guides/backpressuring-in-streams/)

- [Why I don't use Node's core 'stream' module - Rod Vagg](https://r.va.gg/2014/06/why-i-dont-use-nodes-core-stream-module.html)


---

# Streams

### –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–æ–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

```
const stream = require('stream')
```

- –ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ø–æ—Ç–æ–∫–æ–º –≤ `Node`?
- –î–ª—è —á–µ–≥–æ –Ω—É–∂–Ω—ã –ø–æ—Ç–æ–∫–∏?

.center[
![question](assets/question.png)
]

---

# –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Ç–æ–∫–æ–≤

- –û–±—ä–µ–∫—Ç—ã `request`, `response` HTTP —Å–µ—Ä–≤–µ—Ä–∞

```
const server = http.createServer((req, res) => {
  res.statusCode = 200 
  res.end()
})
```

- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ `process.stdin`, `process.stdout`

```
process.stdin.setEncoding('utf8')
process.stdin.on('readable', () => { 
  const chunk = process.stdin.read()
  // ...
})
 
process.stdout.write('end')
// console.log('end')
```

---

# Types of Streams

- Readable - –¥–ª—è —á—Ç–µ–Ω–∏—è
- Writable - –¥–ª—è –∑–∞–ø–∏—Å–∏
- Duplex - –∫–æ–º–±–∏–Ω–∞—Ü–∏—è
- Transform - –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- PassThrough - –ø—Ä–æ—Å—Ç–µ–π—à–∏–π Transform

.right-image[![stream](assets/node/streams.png)]

> Transform streams are Duplex streams where the output is in some way related to the input 

ü§î

---

# Readable API

Streams —è–≤–ª—è—é—Ç—Å—è `EventEmitter`

- `on('data')`
- `on('readable')`
- `read()` –¥–ª—è —á—Ç–µ–Ω–∏—è

```
let body = []
request.on('data', (chunk) => { 
  body.push(chunk)
})
.on('end', () => { 
  body = Buffer.concat(body).toString()
})
```

---

# Writable API

–Ø–≤–ª—è–µ—Ç—Å—è `EventEmitter`

- `write()`, `end()` –¥–ª—è Writable

```
response.write('<html>')
response.write('<body>')
response.write('<h1>Hello, World!</h1>')
response.write('</body>')
response.write('</html>')
response.end()
```

---

# HTTP Server

```
const http = require('http')
http.createServer((request, response) => {
  const { headers, method, url } = request
  let body = [] 
  
  request.on('data', (chunk) => {
    body.push(chunk)
  })
  .on('end', () => {
    body = Buffer.concat(body).toString() 
    response.statusCode = 200 
    response.setHeader('Content-Type', 'application/json') 
    const responseBody = { headers, method, url, body }
    response.write(JSON.stringify(responseBody)) 
    response.end()
  })
})
.listen(8080)
```

- –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å?

---

# –ó–∞–¥–∞—á–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ `process.stdin`, `process.stdout` –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏

```bash
node index.js

enter your name
Alex
your name is Alex
```

```
http.createServer((request, response) => {
  request.on('data', () => {
    /* ... */
  })
  .on('end', () => {
    response.write(/* ... */) 
    response.end()
  })
})
```

---

# –û–±—ä–µ–∫—Ç—ã –∞—Ä–≥—É–º–µ–Ω—Ç—ã

.hidden[
  https://medium.freecodecamp.org/do-you-want-a-better-understanding-of-buffer-in-node-js-check-this-out-2e29de2968e8
]

- `Buffer, String` —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ
- `Object` –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Å `objectMode`

```
const stream = require('stream')
const readable = (function() { 
  const data = [] 
  const $ = new stream.Readable({ objectMode: true, read() {} }) 
  $.push({ a: 1 }) 
  return $
})()

readable.on('data', (data) => { 
  console.log(data)
})
```

---

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤

- `new Writable()` - –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- `class MyWritable extends Writable` - –∫–ª–∞—Å—Å

```
const stream = require('stream')
const writable = (function(){ 
  const data = [] 
  const $ = new stream.Writable({ 
    write(chunk, encoding, callback) { 
      data.push(chunk.toString()) 
      callback() 
    } 
  }) 
  return $
})()

writable.write('some data')
writable.end('done writing data')
writable.on('finish', () => { 
  console.log('All writes are now complete.')
})
```

---

# Demo

.hidden[
// node/stream/read.js
https://www.freecodecamp.org/news/node-js-streams-everything-you-need-to-know-c9141306be93/
]

```
const fs = require('fs')
const server = require('http').createServer()

server.on('request', (req, res) => {
  fs.readFile('./big.file', (err, data) => {
    if (err) throw err
  
    res.end(data)
  })
})

server.listen(8000)
```

---

# Pipe

`Readable.pipe()` —Å–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫, –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ `Writable`

```
readable.on('data', (chunk) => { 
  writable.write(chunk)
})

readable.on('end', () => { 
  writable.end()
})
// -> 
readable.pipe(writable)
```

.half-image[![pipe](assets/stream/pipe.png)]

---

# Buffering


- `highWaterMark` - —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
- `writable.write()` - `true / false`
- `drain` - —Å–æ–±—ã—Ç–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è

.half-image[![highWaterMark](assets/stream/highWaterMark.png)]

---

# –ó–∞–¥–∞—á–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –∏ `pipe` –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤–≤–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```bash
node index.js

abc
abc
123
123
```

---

# Async Patterns

.right-image[
  ![async](assets/async-patterns.png)
]

- `Callback`
- `Promise`
- Async / Await
- Generator
- `Observable`

---

# Iterators

```
const iterable = {
 [Symbol.iterator]() {
   let step = 0
   const iterator = {
     next() {
       if (step <= 2) {
         step++
       }
       switch (step) {
         case 1:
           return { value: 'hello', done: false }
         case 2:
           return { value: 'world', done: false }
         default:
           return { value: undefined, done: true }
       }
     }
   }
   return iterator
 }
}
```

- –ö–∞–∫ –º–æ–∂–Ω–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è?

---

# Iterating

```
const str = 'hi'
const iterator = str[Symbol.iterator]()
iterator.next() // {value: "h", done: false}
iterator.next() // {value: "i", done: false}
iterator.next() // {value: undefined, done: true}
iterator.next() // {value: undefined, done: true}
```

–ò–ª–∏

```
for (i of iterable) {
  console.log(i)
}
```

.hidden[
- Symbol.iterator()
- iterator factory  
- { next() }
- ({ value, done })

var it = iterable[Symbol.iterator]()
for (i of iterable) {
  console.log(i)
}
]

---

# Iterable Streams
 
```
for await (const k of readable) {
  data += k
}

const readStream = fs.createReadStream('./test.txt', { encoding: 'utf8' })

async function print() { 
  for await (const chunk of readStream) {
    console.log(chunk)
  }
}
  
print()
```

.hidden[
  /Users/RD25XO/Developer/experiments/notes/otus/node/stream/for-await-of.js
]

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Streams Q&A

---

# Errors

- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫ JavaScript
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ API
- Assertion Errors
- User Errors

---

# –í–æ–ø—Ä–æ—Å - –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏

### –ß—Ç–æ –∫ —á–µ–º—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è?

.left-code[
```
1. EvalError 
2. SyntaxError
3. RangeError
4. ReferenceError
5. TypeError
6. URIError
```
]

.right-code[
```
/*a*/ var a = undefinedVariable
/*b*/ throw new EvalError('error')
/*c*/ decodeURIComponent('%')
/*d*/ eval('hoo bar')
/*e*/ undefined.not()
/*f*/ [].length = 'Wat?'
```
]

---

# –í–æ–ø—Ä–æ—Å

–ö–∞–∫–∏–µ —Å–ø–æ—Å–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤—ã –∑–Ω–∞–µ—Ç–µ?

```
require('fs')
 .readdir('not exist', () => { 
   throw new Error('test') 
  })
```

---

# –°–ø–æ—Å–æ–±—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

- try / catch / finally 
- callback(err, res)
- on('error')
- Promise.reject()

```
try { 
  require('not exist')
} 
catch(e) { 
  debugger
} 
finally { 
  console.log('go on')
}
```

---

# –í–æ–ø—Ä–æ—Å

### –ß—Ç–æ –∑–¥–µ—Å—å –Ω–µ —Ç–∞–∫?

```
try { 
  require('fs')
    .readdir('not exist', () => { 
      throw new Error('test') 
    })
} catch(e) { 
  console.log('error')
}
```

---

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- .red[new Error(message)]

### –°–≤–æ–π—Å—Ç–≤–∞
- error.message
- error.code - —Å—Ç—Ä–æ–∫–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `E_ERROR_TITLE`
- error.stack —Å .green[Error.captureStackTrace(error)]

---

# Process Events

.right-image[![Node](assets/node.png)]

### EventEmitter
- .blue['error'] - –≤—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

### Process
- .blue['uncaughtException'] - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª–æ–≤–∞
- .blue['unhandledRejection'] - –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ Promise

---

# Demo

–° –ø–æ–º–æ—â—å—é `process.on('uncaughtException')` –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –∏ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∏–ø –æ—à–∏–±–∫–∏ (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ `Error`, –Ω–æ –≤–∫–ª—é—á–∞—è —Å—Ç—ç–∫)

```bash
node error.js
Error
./errors/error.js:2:9)
    at emitOne (events.js:116:13)
    at process.emit (events.js:211:7)
    at process._fatalException (bootstrap_node.js:374:26)
```

---

# How To Error

- .green[DO] use Promises / async / await with catch() 
- .green[DO] use Error class
- .red[DO NOT] throw 'strings or something'
- .green[DO] use central error handling and logging
- .red[DO NOT] continue with unknown 'uncaughtException'
- .green[DO] 'unhandledRejection' handling

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# Errors Q&A

---

# –ù–∞ –∑–∞–Ω—è—Ç–∏–∏

- –†–∞–±–æ—Ç–∞–ª–∏ —Å –∫–ª–∞—Å—Å–∞–º–∏, –æ–±—ä–µ–∫—Ç–∞–º–∏ –∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–¥—É–ª—è `Streams`
- –†–∞–∑–æ–±—Ä–∞–ª–∏ –ø—Ä–∏–º–µ—Ä—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ `JavaScript` –∫–æ–¥–∞

---

# Modern JavaScript Frameworks

.mario.mario-4[![mario](assets/mario.png)]
<!-- .mario.mushroom[![mushroom](assets/mario_mushroom.png)] -->

| ![JS](assets/icons/trim/js.png) | ![Node](assets/icons/trim/node.png) | ![Web Components](assets/icons/trim/webcomponents.png) | ![React](assets/icons/trim/react.png) | ![Vue](assets/icons/trim/vue.png) | ![Angular](assets/icons/trim/angular.png) |
|:---:|:---:|:---:|:---:|:---:|:---:|
| ![Google Chrome](assets/icons/trim/google_chrome.png) | ![NPM](assets/icons/trim/npm.png) | ![polymer](assets/icons/trim/polymer.png) | ![redux](assets/icons/trim/redux.png) | | ![ts](assets/icons/trim/ts.png) |
| ![wasm](assets/web-assembly-logo.png) | ![v8](assets/icons/trim/v8.png) | | ![react-router](assets/icons/trim/react-router.png) | | ![rxjs](assets/icons/trim/rxjs.png) |
| | ![Express](assets/icons/trim/express.png) | |
| | ![GraphQL](assets/icons/trim/graphql.png) | |

---

# –ó–∞–¥–∞—á–∞

### –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Ü–µ–ª—ã–º–∏ —á–∏—Å–ª–∞–º–∏ —Ä–∞–∑–º–µ—Ä–æ–º 100 –ú–ë, –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ - 50 –ú–ë. –†–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ—Ç–æ–∫–æ–≤.

---

class: white
background-image: url(assets/title.svg)
.top.icon[![otus main](assets/otus-2.png)]

# –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ!
.black[ 
## –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ –æ–ø—Ä–æ—Å 
## –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ 
]